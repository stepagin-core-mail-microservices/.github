# Микросервисы mail и core для работы с изображениями и почтой

**Автор: Понамарев Степан**

GitHub: https://github.com/stepagin

## Описание

### Использованные технологии

**Язык** - Java 17

**Фреймворки**:

* Spring Boot 3.3.1
* Spring Data
* Spring Security (Basic Auth)
* Kafka

**База данных**: PostgreSQL

**Автоматизация сборки** – Maven

### Доменная модель

Было использовано 2 таблицы: Image и User

Сущность User:

|    | user            |
|----|-----------------|
| PK | Long id         |
| U  | String login    |
| U  | String email    |
|    | String password |
|    | boolean blocked |
|    | Role[] roles    |

Сущность Image:

|    | image                      |
|----|----------------------------|
| PK | UUID id                    |
| FK | UserEntity owner           |
|    | String name                |
|    | Long size                  |
|    | String contentType         |
|    | LocalDateTime creationDate |
|    | byte[] bytes               |

где:

* PK - Primary Key
* FK - Foreign Key
* U - Unique

Доменная модель микросервиса Mail выглядит аналогичным образом.

### Архитектура

1. МИКРОСЕРВИС-MAIL
    * Через брокер сообщений получает от микросервиса core информацию о полученном изображении и посылает на email
      пользователя письмо с соответствующим описанием события
2. МИКРОСЕРВИС-CORE.
    * Принимает все входящие запросы и обрабатывает их
    * Реализует авторизацию и аутентификацию пользователей
    * у пользователя может быть роль USER или MODERATOR.

## Запуск

### Первоначальная настройка

Перед запуском убедитесь, что у вас установлена соответсвующая версия Java, и PostgreSQL принимает входящие подключения.

Пошаговая инструкция:

1. Запустите сервер Kafka и ZooKeeper

* Можно сделать это локально или указать адрес удалённого сервера в `src/main/resources/application.properties` в обоих
  микросервисах
  (параметр `spring.kafka.bootstrap-servers`)

2. Укажите в `application.properties` логин и пароль от почты mail.ru

* Логин - параметр `spring.mail.username`
* Пароль - параметр `spring.mail.password`
* Пароль можно сгенерировать отдельно, документация mail.ru подскажет как это сделать.

3. Укажите в `application.properties` логин и пароль от базы данных `postgres`

* Логин - параметр `spring.datasource.username`
* Пароль - параметр `spring.datasource.password`

4. Создайте схемы `core` и `mail` в базе данных `postgres`:

```sql 
create schema mail;
create schema core;
```

* Убедитесь, что пользователь, указанный в `application.properties` имеет доступ к таблицам в этих схемах
* При желании можно переименовать используемые схемы в `application.properties` (
  параметр `spring.jpa.properties.hibernate.default_schema`)

### Запуск

1. Запустите Core микросервис

* После ввода данных соберите jar-файл с помощью Maven, он появится в папке target

```shell
.\mvnw clean package
```

* Команда запуска jar-файла:

```shell
java -jar core-1.0.jar
```

* Core микросервис запустится на порте 18006

2. Запустите Mail микросервис

* Аналогично сервису Core, после ввода данных соберите jar-файл и запустите его.

```shell
java -jar mail-1.0.jar
```

* Core микросервис запустится на порте 18007

### Дополнительно

* В целях безопасности и экономии времени не был реализован эндпоинт выдачи прав модератора обычному пользователю.
* Чтобы выдать права пользователю права модератора, откройте консоль PostgreSQL и выполните скрипт:

```sql 
update core.person
set roles = ARRAY [0,1]
where login = 'ваш логин';
```

## API

API приложения можно посмотреть в документации (Postman):
https://documenter.getpostman.com/view/33960847/2sA3XV8esQ

### Сортировка и фильтрация

API получения списка изображений позволяет отсортировать и фильтровать список. 

Для сортировки необходимо передать параметр sort, перечисляя атрибуты через запятую и перед каждым указывать знак "+" или "-", что означает сортировку по возрастанию или по убыванию.

Например:

* GET: /images?sort=+size - сортировка во возрастанию size
* GET: /images?sort=+creationDate,-size - отсортировать по возрастанию даты создания, а затем по убыванию size

Для фильтрации можно передать любые из параметров: creationDate, size и id. чтобы указать промежуток, необходимо указать  2 значения через запятую. Для id будет проверяться наличие подстроки id в UUID элементов списка.

Например:

* GET: /images?size=64000 - поиск изображений, у которых size равен 64 Кб
* GET: /images?date=2024-06-20 00:00:00,2024-06-20 23:59:59 - поиск изображений, которые были созданы 20 июня 2024 года


Также реализована пагинация. Передаваемые параметры:

* page - номер страницы, нумерация начинается с нуля
* limit - количество элементов на странице

## Особенности реализации

* После регистрации в приложении на email пользователя приходит приветственное сообщение;
* При регистрации не обязательно указывать email, его добавить/обновить позже;
* Приветсвенное письмо придёт только при первом указании email;
* Реализован эндпоинт по которому пользователь может загрузить список изображений jpg или png, каждое весом не более 10
  MB;
* Изображжения сохраняются в базу данных на диске;
* После загрузки микросервис mail отправляет информацию об изображении на почту пользователю, который его загрузил;
* реализован эндпоинт, по которому пользователь может получить список загруженных им изображений с возможностью
  сортировки и фильтрации изображений по дате загрузки, id и размеру;
* реализован эндпоинт, по которому пользователь может скачать изображение, если изображение не принадлежит пользователю,
  запрос должен быть отклонен;
* После скачивания, mail сервис уведомляет пользователя, что было скачано изображение, c указанием имени файла и его
  размера;


